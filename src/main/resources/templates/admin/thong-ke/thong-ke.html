<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<div th:replace="components/head :: head"></div>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nine Shoes</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0/dist/css/tabler.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* B·ªë c·ª•c ch√≠nh */
    .admin-layout {
        display: flex;
        height: 100vh;
    }

    /* Sidebar b√™n tr√°i */
    .sidebar {
        width: 250px;
        background-color: #1E293B;
        color: white;
        padding: 20px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
    }

    /* Khu v·ª±c b√™n ph·∫£i (navbar + n·ªôi dung) */
    .right-content {
        flex-grow: 1;
        margin-left: 240px; /* ƒê·ªÉ tr√°nh b·ªã sidebar che */
        display: flex;
        flex-direction: column;
        width: calc(100% - 250px);
    }

    /* Navbar c·ªë ƒë·ªãnh b√™n tr√™n */
    .navbar-custom {
        height: 50px;
        padding: 12px 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        width: calc(100% - 250px);
        z-index: 1000;
    }

    /* N·ªôi dung ch√≠nh (c√≥ padding ƒë·ªÉ tr√°nh navbar che) */
    .main-content {
        margin-top: 30px;
        padding: 50px 15px;
        overflow-y: auto;
        flex-grow: 1;
    }


    /* Responsive: ·∫®n sidebar tr√™n mobile */
    @media (max-width: 768px) {
        .sidebar {
            width: 80px;
            padding: 10px;
        }

        .right-content {
            margin-left: 80px;
            width: calc(100% - 80px);
        }

        .navbar-custom {
            width: calc(100% - 80px);
        }
    }

    #chartDoanhThu {
        max-width: 100%;
        margin: 20px auto;
    }
</style>

<body>
<div class="admin-layout">
    <div th:replace="~{components/admin-sidebar :: admin-sidebar}" class="sidebar">
        <!-- N·ªôi dung sidebar -->
    </div>
    <!-- Khu v·ª±c b√™n ph·∫£i -->
    <div class="right-content">
        <!-- Navbar -->
        <nav class="navbar-custom"
             th:replace="~{components/admin-navbar :: admin-navbar}">
        </nav>

        <!-- Main content -->
        <div class="main-content">
            <div class="card shadow-sm p-3">
                    <form action="/thong-ke" method="get" class="row g-3 align-items-end" id="form-loc-thong-ke">
                        <!-- Ki·ªÉu l·ªçc -->
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Ki·ªÉu l·ªçc</label>
                            <select name="kieuLoc" class="form-select">
                                <option value="ngay" th:selected="${kieuLoc == 'ngay'}">Theo ng√†y</option>
                                <option value="thang" th:selected="${kieuLoc == 'thang'}">Theo th√°ng</option>
                                <option value="nam" th:selected="${kieuLoc == 'nam'}">Theo nƒÉm</option>
                            </select>
                        </div>

                        <!-- T·ª´ ng√†y - ƒë·∫øn ng√†y -->
                        <div class="col-md-2" id="locNgay">
                            <label for="tuNgay" class="form-label fw-bold">T·ª´ ng√†y</label>
                            <input type="date" class="form-control" id="tuNgay" name="tuNgay"
                                   th:value="${tuNgay != null ? #dates.format(tuNgay, 'yyyy-MM-dd') : ''}">
                        </div>
                        <div class="col-md-2" id="locNgayDen">
                            <label for="denNgay" class="form-label fw-bold">ƒê·∫øn ng√†y</label>
                            <input type="date" class="form-control" id="denNgay" name="denNgay"
                                   th:value="${denNgay != null ? #dates.format(denNgay, 'yyyy-MM-dd') : ''}">
                        </div>

                        <!-- Th√°ng -->
                        <div class="col-md-2" id="locThang">
                            <label for="thang" class="form-label fw-bold">Th√°ng</label>
                            <select class="form-select" id="thang" name="thang">
                                <option value="">-- Ch·ªçn th√°ng --</option>
                                <option th:each="i : ${#numbers.sequence(1, 12)}"
                                        th:value="${i}"
                                        th:text="${i}"
                                        th:selected="${thang != null and thang == i}">
                                </option>
                            </select>
                        </div>

                        <!-- NƒÉm -->
                        <div class="col-md-2" id="locNam">
                            <label for="nam" class="form-label fw-bold">NƒÉm</label>
                            <select class="form-select" id="nam" name="nam">
                                <option value="">-- Ch·ªçn nƒÉm --</option>
                                <option th:each="n : ${#numbers.sequence(2020, 2030)}"
                                        th:value="${n}"
                                        th:text="${n}"
                                        th:selected="${nam != null and nam == n}">
                                </option>
                            </select>
                        </div>

                        <!-- Buttons -->
                        <div class="col-md-2 d-flex gap-2">
                            <button type="submit" class="btn btn-primary w-100">
                                L·ªçc
                            </button>
                            <a href="/thong-ke" id="btn-reset-loc" class="btn btn-outline-secondary w-100">
                                B·ªè l·ªçc
                            </a>
                        </div>
                    </form>
                </div>


            <div class="row">
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">K·∫øt qu·∫£ kinh doanh trong ng√†y</h3>
                    </div>
                    <div class="card-body border-bottom py-3">
                        <div class="row">
                            <!-- Doanh thu -->
                            <div class="col-md-4">
                                <div class="card text-white bg-success mb-3">
                                    <div class="card-header d-flex justify-content-center">
                                        <h2 class="m-0">Doanh thu</h2>
                                    </div>

                                    <div class="card-body">
                                        <h3 class="text-center">
          <span th:text="${
    #numbers.formatDecimal(
        doanhThuKhoang != null ? doanhThuKhoang
        : (doanhThuTheoThang != null ? doanhThuTheoThang
        : (doanhThuTheoNam != null ? doanhThuTheoNam
        : doanhThu)),
        0, 'COMMA', 0, 'COMMA'
    ).replace(',', '.') + ' ƒë'
}">0 VNƒê</span>
                                        </h3>
                                    </div>
                                </div>
                            </div>

                            <!-- ƒê∆°n ho√†n th√†nh -->
                            <div class="col-md-4">
                                <div class="card text-white bg-info mb-3">
                                    <div class="card-header d-flex justify-content-center">
                                        <h2 class="m-0">ƒê∆°n ho√†n th√†nh</h2>
                                    </div>
                                    <div class="card-body">
                                        <h3 class="text-center">
                    <span th:text="${soDonHoanThanhKhoang != null ? soDonHoanThanhKhoang
                            : (soDonHoanThanhThang != null ? soDonHoanThanhThang
                            : (soDonHoanThanhNam != null ? soDonHoanThanhNam
                            : donHangHomNay))}">0</span>
                                        </h3>
                                    </div>
                                </div>
                            </div>

                            <!-- ƒê∆°n h·ªßy -->
                            <div class="col-md-4">
                                <div class="card text-white bg-danger mb-3">
                                    <div class="card-header d-flex justify-content-center">
                                        <h2 class="m-0">ƒê∆°n ƒë√£ h·ªßy</h2>
                                    </div>

                                    <div class="card-body">
                                        <h3 class="text-center">
                    <span th:text="${soDonHuyKhoang != null ? soDonHuyKhoang
                            : (soDonHuyThang != null ? soDonHuyThang
                            : (soDonHuyNam != null ? soDonHuyNam
                            : donHuyHomNay))}">0</span>
                                        </h3>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title">Th·ªëng k√™ doanh thu</h3>
                </div>
                <div class="card-body border-bottom py-3">
                    <div class="row">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-body">
                                    <div id="chartDoanhThu" th:if="${bieuDoMau == 'khac'}"></div>
                                    <div id="chartDoanhThuGio" th:if="${bieuDoMau == 'gio'}"></div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-3">

                <div class="card mt-3 w-75 shadow-lg rounded-4 border-0">
                    <div class="card-header bg-primary text-white rounded-top-4 py-4">
                        <h3 class="card-title fw-bold mb-1">üî• Top 5 s·∫£n ph·∫©m b√°n ch·∫°y</h3>
                    </div>

                    <div class="card-body p-4">
                        <table class="table table-hover table-bordered align-middle text-center shadow-sm rounded-3 overflow-hidden">
                            <thead class="table-light fw-semibold">
                            <tr>
                                <th>STT</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th>S·ªë l∆∞·ª£ng b√°n</th>
                                <th>Doanh thu</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="sp, iterStat : ${topSanPhamBanChay}">
                                <td th:text="${iterStat.index + 1}" class="fw-bold text-primary"></td>
                                <td th:text="${sp.tenSanPham}" class="fw-medium text-dark"></td>
                                <td th:text="${sp.tongSoLuongBan}" class="text-success fw-semibold"></td>
                                <td th:text="${#numbers.formatDecimal(sp.tongDoanhThu, 0, 'COMMA', 0, 'COMMA').replace(',', '.') + ' ƒë'}"
                                    class="text-danger fw-bold"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card mt-3 w-75 shadow-lg rounded-4 border-0">
                    <div class="card-header bg-warning text-dark py-4 rounded-top-4">
                        <h3 class="card-title fw-bold mb-0">‚ö†Ô∏è Top 10 s·∫£n ph·∫©m s·∫Øp h·∫øt</h3>
                    </div>

                    <div class="card-body p-4">
                        <table class="table table-hover table-bordered align-middle text-center shadow-sm rounded-3 overflow-hidden">
                            <thead class="table-light fw-semibold">
                            <tr>
                                <th>STT</th>
                                <th>M√£ s·∫£n ph·∫©m</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th class="text-danger">S·ªë l∆∞·ª£ng c√≤n l·∫°i</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="sp, iterStat : ${topSanPhamSapHet}">
                                <td th:text="${iterStat.index + 1}" class="fw-bold text-primary"></td>
                                <td th:text="${sp.maSanPham}" class="text-dark fw-medium"></td>
                                <td th:text="${sp.tenSanPham}" class="text-dark"></td>
                                <td th:text="${sp.tongSoLuongTon}" class="fw-bold text-danger"></td>
                            </tr>
                            </tbody>
                        </table>

                    </div>
                </div>


            </div>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script th:inline="javascript">
    let ngayLoc = [[${ngayLoc}]];
    let doanhThuLoc = [[${doanhThuLoc}]];
    let kieuLoc = /*[[${kieuLoc}]]*/ null;
    let bieuDoMau = /*[[${bieuDoMau}]]*/ "gio";

    let gioTrongNgay = /*[[${gioTrongNgay}]]*/ [];
    let doanhThuTheoGio = /*[[${doanhThuTheoGio}]]*/ [];

    if (bieuDoMau === 'khac') {
        let titleText = 'Bi·ªÉu ƒë·ªì doanh thu theo ';
        if (kieuLoc === 'ngay') titleText += 'ng√†y';
        else if (kieuLoc === 'thang') titleText += 'th√°ng';
        else if (kieuLoc === 'nam') titleText += 'nƒÉm';
        else titleText += 'gi·ªù'; // fallback

        let options = {
            chart: {
                type: 'bar',
                height: 350,
                toolbar: {show: false}
            },
            title: {
                text: titleText,
                align: 'center',
                style: {
                    fontSize: '17px',
                    fontWeight: 'bold',
                    color: '#263238'
                }
            },
            plotOptions: {
                bar: {
                    columnWidth: '50%',
                    distributed: true,
                    borderRadius: 4
                }
            },
            series: [{
                name: 'Doanh thu',
                data: doanhThuLoc
            }],
            xaxis: {
                categories: ngayLoc,
                title: {text: 'Th·ªùi gian'},
                labels: {
                    rotate: -45
                }
            },
            yaxis: {
                title: {text: 'Doanh thu (VNƒê)'},
                labels: {
                    formatter: function (val) {
                        return val.toLocaleString('vi-VN') + ' ƒë';
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toLocaleString('vi-VN') + ' ƒë';
                    }
                }
            },
            colors: ['#FF4560', '#008FFB', '#00E396', '#FEB019', '#775DD0',
                '#3F51B5', '#546E7A', '#D4526E', '#8D5B4C', '#F86624',
                '#2E294E', '#1B998B', '#E84855', '#FF8066', '#AA00FF',
                '#00BCD4', '#FFB300', '#66BB6A', '#FF7043', '#D4E157',
                '#6A1B9A', '#3949AB', '#039BE5', '#C2185B'],
            dataLabels: {
                enabled: false
            }
        };

        let chart = new ApexCharts(document.querySelector("#chartDoanhThu"), options);
        chart.render();
    }

    if (bieuDoMau === 'gio') {
        let optionsGio = {
            chart: {
                type: 'bar',
                height: 350,
                toolbar: {show: false}
            },
            title: {
                text: 'Bi·ªÉu ƒë·ªì doanh thu theo gi·ªù trong ng√†y h√¥m nay',
                align: 'center',
                style: {
                    fontSize: '17px',
                    fontWeight: 'bold',
                    color: '#263238'
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    horizontal: false,
                    columnWidth: '50%',
                    distributed: true // Cho ph√©p m·ªói c·ªôt c√≥ m√†u ri√™ng
                }
            },
            series: [{
                name: 'Doanh thu',
                data: doanhThuTheoGio
            }],
            xaxis: {
                categories: gioTrongNgay,
                title: {text: 'Gi·ªù trong ng√†y'},
                labels: {
                    style: {
                        colors: gioTrongNgay.map(() => '#000'), // m√†u ch·ªØ tr·ª•c X (n·∫øu mu·ªën)
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                title: {text: 'Doanh thu (VNƒê)'},
                labels: {
                    formatter: function (val) {
                        return val.toLocaleString('vi-VN') + ' ƒë';
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toLocaleString('vi-VN') + ' ƒë';
                    }
                }
            },
            colors: [
                '#FF4560', '#008FFB', '#00E396', '#FEB019', '#775DD0',
                '#3F51B5', '#546E7A', '#D4526E', '#8D5B4C', '#F86624',
                '#2E294E', '#1B998B', '#E84855', '#FF8066', '#AA00FF',
                '#00BCD4', '#FFB300', '#66BB6A', '#FF7043', '#D4E157',
                '#6A1B9A', '#3949AB', '#039BE5', '#C2185B'
            ] // T√πy s·ªë l∆∞·ª£ng gi·ªù b·∫°n c·∫ßn, c√≥ th·ªÉ th√™m ho·∫∑c b·ªõt m√†u ·ªü ƒë√¢y
        };
        let chartGio = new ApexCharts(document.querySelector("#chartDoanhThuGio"), optionsGio);
        chartGio.render();
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('btn-reset-loc').addEventListener('click', function () {
            window.location.href = '/thong-ke'; // Chuy·ªÉn v·ªÅ trang th·ªëng k√™ m·∫∑c ƒë·ªãnh
        });
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0/dist/js/tabler.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const select = document.querySelector("select[name='kieuLoc']");
        const locNgay = document.getElementById("locNgay");
        const locNgayDen = document.getElementById("locNgayDen");
        const locThang = document.getElementById("locThang");
        const locNam = document.getElementById("locNam");

        function toggleFields() {
            const value = select.value;
            locNgay.style.display = value === "ngay" ? "block" : "none";
            locNgayDen.style.display = value === "ngay" ? "block" : "none";
            locThang.style.display = value === "thang" ? "block" : "none";
            locNam.style.display = (value === "thang" || value === "nam") ? "block" : "none";
        }

        select.addEventListener("change", toggleFields);
        toggleFields(); // G·ªçi ban ƒë·∫ßu ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng
    });
</script>

<script>
    document.getElementById("form-loc-thong-ke").addEventListener("submit", function (e) {
        const kieuLoc = document.querySelector("select[name='kieuLoc']").value;
        const tuNgay = document.getElementById("tuNgay").value;
        const denNgay = document.getElementById("denNgay").value;
        const thang = document.getElementById("thang").value;
        const nam = document.getElementById("nam").value;

        // Validate l·ªçc theo ng√†y
        if (kieuLoc === "ngay") {
            if (!tuNgay || !denNgay) {
                e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'Thi·∫øu th√¥ng tin',
                    text: 'Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß "T·ª´ ng√†y" v√† "ƒê·∫øn ng√†y".'
                });
                return;
            }
            if (tuNgay > denNgay) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',
                    text: '"T·ª´ ng√†y" kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n "ƒê·∫øn ng√†y".'
                });
                return;
            }
        }

        // Validate l·ªçc theo th√°ng
        if (kieuLoc === "thang") {
            if (!thang || !nam) {
                e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'Thi·∫øu th√¥ng tin',
                    text: 'Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√°ng v√† nƒÉm.'
                });
                return;
            }
        }

        // Validate l·ªçc theo nƒÉm
        if (kieuLoc === "nam") {
            if (!nam) {
                e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'Thi·∫øu th√¥ng tin',
                    text: 'Vui l√≤ng ch·ªçn nƒÉm.'
                });
                return;
            }
        }
    });
</script>



</body>
</html>