<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0/dist/css/tabler.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> </head>
    <link rel="stylesheet" href="/css/Footer.css">
    <link rel="stylesheet" href="/css/Navbar.css">
</head>

<body>
<div class="">
    <div th:replace="components/navbar :: navbar"></div>
    <div class="container py-5">

        <h2>Thanh to√°n</h2>
        <div class="row">
            <div class="col-12">
                <div th:if="${successMessage}" class="alert alert-success" role="alert">
                    <span th:text="${successMessage}"></span>
                </div>
            </div>
            <div class="col-6">
                <div class="card cart-summary">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Th√¥ng tin giao h√†ng</h5>
                        <!-- Errrrr -->
                        <div th:if="${errorMessage}" class="alert alert-danger mb-3">
                            <strong th:text="${errorMessage}"></strong>
                            <ul th:if="${errors}">
                                <li th:each="err : ${errors}" th:text="${err}"></li>
                            </ul>
                        </div>
                        <form id="checkoutForm" th:action="@{/shop/place-order}" method="post" th:object="${hoaDonBinhRequest}">
                            <div th:if="${khachHang != null}">
                                <div>
                                    <label>H·ªç t√™n: </label>
                                    <span th:text="${khachHang.tenKhachHang}"></span>
                                </div>
                                <div>
                                    <label>Email: </label>
                                    <span th:text="${khachHang.taiKhoan.email}"></span>
                                </div>
                                <div>
                                    <label>SƒêT: </label>
                                    <span th:text="${khachHang.taiKhoan.sdt}"></span>
                                </div>

                                <h3>Ch·ªçn ƒë·ªãa ch·ªâ nh·∫≠n h√†ng</h3>
                                <div th:each="dc : ${khachHang.diaChi}">
                                    <label>
                                        <input type="radio" name="diaChiId" th:value="${dc.id}" required>
                                        <span th:text="${dc.diaChiCuThe + ', ' + dc.xa + ', ' + dc.huyen + ', ' + dc.tinh}"></span>
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary">ƒê·∫∑t h√†ng</button>
                                </div>
                            </div>
                            <div th:if="${khachHang == null}">
                                <div class="mb-3">
                                    <label class="form-label">H·ªç v√† t√™n:</label>
                                    <input th:field="*{tenNguoiNhan}" type="text" class="form-control">
                                    <small th:errors="*{tenNguoiNhan}" class="text-danger"></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
                                    <input th:field="*{sdtNguoiNhan}" type="text" class="form-control">
                                    <small th:errors="*{sdtNguoiNhan}" class="text-danger"></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email:</label>
                                    <input th:field="*{email}" type="text" class="form-control">
                                    <small th:errors="*{email}" class="text-danger"></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">T·ªânh/Th√†nh ph·ªë:</label>
                                    <select th:field="*{tinh}" id="province" class="form-select">
                                        <option value="">Ch·ªçn t·ªânh/th√†nh</option>
                                    </select>
                                    <small th:errors="*{tinh}" class="text-danger"></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Qu·∫≠n/Huy·ªán:</label>
                                    <select th:field="*{quan}" id="district" class="form-select" disabled>
                                        <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
                                    </select>
                                    <small th:errors="*{quan}" class="text-danger"></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">X√£/Ph∆∞·ªùng:</label>
                                    <select th:field="*{xa}" id="ward" class="form-select" disabled>
                                        <option value="">Ch·ªçn x√£/ph∆∞·ªùng</option>
                                    </select>
                                    <small th:errors="*{xa}" class="text-danger"></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ:</label>
                                    <input th:field="*{diaChiNguoiNhan}" type="text" class="form-select">
                                    <small th:errors="*{diaChiNguoiNhan}" class="text-danger"></small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ghi chu</label>
                                    <textarea th:field="*{ghiChu}" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="mb-3 form-selectgroup">
                                    Thanh to√°n khi nh·∫≠n h√†ng
                                </div>
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary" id="btnSubmit">ƒê·∫∑t h√†ng</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row cart-item mb-3" th:each="item : ${cart}">
                            <div class="col-3">
<!--                                <img src="" alt="Product 1" class="img-fluid rounded" />-->
                                <img th:src="@{'/upload' + ${item.sanPhamChiTiet.hinhAnh[0].tenAnh.substring(item.sanPhamChiTiet.hinhAnh[0].tenAnh.lastIndexOf('upload') + 6)}}" alt="Product 1" class="img-fluid rounded" />
                            </div>
                            <div class="col-6">
                                <h5 class="card-title" th:text="${item.sanPhamChiTiet.sanPham.tenSanPham}"></h5>
                                <p class="text-muted">
                                    Gi√°:
                                    <span
                                            th:text="${#numbers.formatDecimal(item.sanPhamChiTiet.giaBanSauGiam, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span>
                                </p>
                                <div class="row">
                                    <div class="col-6">
                                        <span class="fw-bold">Size: <span th:text="${item.sanPhamChiTiet.kichCo.ten}"></span></span>
                                    </div>
                                    <div class="col-6 d-flex flex-row">
                                        <!-- S·ªë l∆∞·ª£ng hi·ªÉn th·ªã -->
                                        <span class="form-label fw-bold">So luong: <span
                                                th:text="${item.soLuong}"></span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <p class="fw-bold">
                                        <span th:id="'total-price-' + ${item.sanPhamChiTiet.id}"
                                              th:data-total-price="${item.soLuong * item.sanPhamChiTiet.giaBanSauGiam}"
                                              th:text="${#numbers.formatDecimal(item.soLuong * item.sanPhamChiTiet.giaBanSauGiam, 0, 'COMMA', 0, 'POINT')}"></span>
                                    VND
                                </p>
                            </div>
                        </div>
                        <hr />
                    </div>
                </div>

                <!-- Hi·ªÉn th·ªã t·ªïng ti·ªÅn -->
                <div class="card cart-summary">
                    <div class="card-body">
                        <h5 class="card-title">ƒê∆°n h√†ng</h5>
                        <hr/>
                        <div class="d-flex justify-content-between mb-3">
                            <span>T·∫°m t√≠nh</span>
                            <span>
                                    <span class="cart-total-price" th:data-total-price="${tongTamTinh}"
                                          th:text="${#numbers.formatDecimal(tongTamTinh, 0, 'COMMA', 0, 'POINT')}"></span>
                                    VND
                                </span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span>
                                    <span class="cart-total-price"
                                          th:text="${tongTamTinh > 1000000? '0' : '30.000'}"></span>
                                    <span> VND</span>
                                </span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Gi·∫£m gi√°</span>
                            <span>0<span> VND</span></span>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between mb-4">
                            <strong>Th√†nh ti·ªÅn</strong>
                            <strong>
                                    <span class="cart-total-price-end"
                                          th:text="${#numbers.formatDecimal(tongTamTinh + (tongTamTinh > 1000000 ? 0 : 30000), 0, 'COMMA', 0, 'POINT')}"></span>
                                VND
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Form nh·∫≠p th√¥ng tin ƒë·∫∑t h√†ng -->
    </div>
    <div th:replace="~{components/footer :: footer}"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-none justify-content-center align-items-center" style="z-index: 1050;">
        <div class="text-center text-white">
            <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="fs-5">üïê H·ªá th·ªëng ƒëang ti·∫øn h√†nh x·ª≠ l√Ω ƒë∆°n h√†ng, vui l√≤ng ƒë·ª£i...</div>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.1.1/dist/js/tabler.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
<script src="/js/checkout.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("checkoutForm");
        const submitButton = document.getElementById("btnSubmit");
        const overlay = document.getElementById("loadingOverlay");

        form.addEventListener("submit", function(event) {
            overlay.classList.remove("d-none"); // Hi·ªán overlay Bootstrap
            submitButton.disabled = true;

            // Optional: disable to√†n b·ªô n√∫t kh√°c
            const buttons = form.querySelectorAll("button");
            buttons.forEach(btn => btn.disabled = true);
        });
    });
</script>
</body>
</html>